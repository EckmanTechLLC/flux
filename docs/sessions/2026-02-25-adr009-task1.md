# Session: ADR-009 Task 1 — DELETE namespace endpoint

**Date:** 2026-02-25
**Status:** Complete

---

## Task

Add `DELETE /api/namespaces/:name` endpoint to Flux, gated by `FLUX_ADMIN_TOKEN`.
Required by ADR-009 provisioner admin panel for namespace revocation.

---

## Files Modified

1. **`src/namespace/store.rs`**
   - Added `delete(&self, name: &str) -> Result<()>`
   - `DELETE FROM namespaces WHERE name = ?1` — Ok(()) regardless of rows affected
   - Tests: `test_delete_existing`, `test_delete_nonexistent_is_ok`

2. **`src/namespace/mod.rs`** (`NamespaceRegistry`)
   - Added `delete(&self, name: &str) -> bool`
   - Removes from `names`, `namespaces`, `tokens` maps atomically (DashMap)
   - Calls `store.delete(name)` best-effort (warns on error, still returns true)
   - Returns false if name not in `names` index

3. **`src/namespace/tests.rs`**
   - Added `test_delete_existing_removes_from_all_maps`
   - Added `test_delete_unknown_returns_false`

4. **`src/api/namespace.rs`**
   - Added `delete` to `routing::{delete, get, post}` import
   - Route: `get(lookup_namespace).delete(delete_namespace)` on `/api/namespaces/:name`
   - Handler `delete_namespace`: checks Bearer token vs `state.admin_token` (None → allow)
   - Returns 401 if token missing/wrong, 404 if not found, 204 on success
   - Tests: missing token → 401, wrong token → 401, unknown → 404, valid → 204

---

## Auth Logic

- `admin_token: None` → DELETE allowed without token (auth disabled)
- `admin_token: Some(t)` → Bearer token must match, else 401
- No `AuthDisabled` guard (unlike `register_namespace`) — delete is always permitted when auth is off

---

## Test Command

```
cargo test -p flux
```

Expected: all existing tests pass + 6 new tests pass (2 store, 2 registry, 4 API)
