# Session: ADR-009 Task 3 — Admin Panel

**Date:** 2026-02-25
**Status:** Complete

---

## Task

Add admin panel to flux-provisioner: 4 routes + admin.html template.

---

## Changes

### `/home/etl/flux-provisioner/app.py`
- Added `render_template` to Flask import
- Added `ADMIN_TOKEN = os.environ.get("ADMIN_TOKEN", "")` to config block
- Added `check_admin_token()` helper — reads `?token=` query param, returns bool
- Added `GET /admin` — token check, renders `templates/admin.html`
- Added `GET /admin/api/namespaces` — returns all rows from SQLite ordered by `created_at DESC`
- Added `POST /admin/api/namespaces` — manual provision: auto-generate name or use provided name, POST to Flux, INSERT to SQLite with `stripe_session_id="manual-{timestamp}"`, send email, return 201
- Added `POST /admin/api/namespaces/<name>/revoke` — DELETE from Flux (404 tolerated), UPDATE SQLite status='revoked', return 200

### `/home/etl/flux-provisioner/templates/admin.html` (new)
- Stats bar: total / active / revoked (computed from table data in JS)
- Manual provision form: email (required) + namespace name (optional)
- Namespaces table: namespace, email, created, status, token (truncated, full on hover), revoke button
- Token read from `?token=` URL param, appended to all API calls
- Revoked rows dimmed via CSS. Revoke button shows confirm dialog.
- ~140 lines, no CDN dependencies

---

## Deployment

On .107, restart the service after copying files:

```bash
sudo systemctl restart flux-provisioner
```

Verify `ADMIN_TOKEN` is set in `/home/etl/flux-provisioner/.env`.

Access: `http://192.168.50.107:3002/admin?token=YOUR_TOKEN`

---

## Notes

- `POST /admin/api/namespaces` with explicit `name` skips uniqueness pre-check — Flux returns an error if the name is taken (caller sees it)
- Revoke tolerates Flux 404 (namespace may already be gone) — SQLite still updated
- Task 1 (DELETE /api/namespaces/:name in Flux) must be deployed for revoke to work end-to-end
