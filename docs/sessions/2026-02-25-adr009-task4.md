# ADR-009 Task 4 — Deployment & Stripe Wiring

**Date:** 2026-02-25
**Status:** Ready to execute

---

## Prerequisite Check

Before starting, confirm Tasks 1–3 are complete:
- Task 1: `DELETE /api/namespaces/:name` is in the Flux source on dev
- Task 2–3: `app.py`, `templates/admin.html`, `requirements.txt`, `.env.template`, `flux-provisioner.service` all exist at `/home/etl/flux-provisioner/` on dev

---

## Phase 1 — Deploy Task 1 (Flux DELETE endpoint) to .107

Run on **.107**:

```bash
cd /home/etl/flux
git pull
docker compose build --no-cache flux && docker compose up -d flux
```

Verify the new endpoint exists:
```bash
curl -s -o /dev/null -w "%{http_code}" \
  -X DELETE http://localhost:3000/api/namespaces/nonexistent \
  -H "Authorization: Bearer $(grep FLUX_ADMIN_TOKEN /home/etl/flux/.env | cut -d= -f2)"
# Expected: 404 (not 405 Method Not Allowed)
```

---

## Phase 2 — Copy provisioner files to .107

Run on **dev** (`192.168.50.107` is reachable from dev):

```bash
# Create target directories on .107
ssh etl@192.168.50.107 "mkdir -p /home/etl/flux-provisioner/templates"

# Copy all provisioner files
rsync -av \
  /home/etl/flux-provisioner/app.py \
  /home/etl/flux-provisioner/requirements.txt \
  /home/etl/flux-provisioner/.env.template \
  /home/etl/flux-provisioner/flux-provisioner.service \
  etl@192.168.50.107:/home/etl/flux-provisioner/

rsync -av \
  /home/etl/flux-provisioner/templates/admin.html \
  etl@192.168.50.107:/home/etl/flux-provisioner/templates/
```

---

## Phase 3 — Install Python dependencies on .107

Run on **.107**:

```bash
pip3 install --break-system-packages flask stripe python-dotenv requests gunicorn
```

Note: `gunicorn` is not in `requirements.txt` but is required by the service file. Install it explicitly.

---

## Phase 4 — Configure .env on .107

Run on **.107**:

```bash
cp /home/etl/flux-provisioner/.env.template /home/etl/flux-provisioner/.env
nano /home/etl/flux-provisioner/.env
```

Fill in every variable:

| Variable | Value | Where to find it |
|---|---|---|
| `FLUX_ADMIN_TOKEN` | (your admin token) | `grep FLUX_ADMIN_TOKEN /home/etl/flux/.env` |
| `FLUX_API_URL` | `http://localhost:3000` | hardcoded — no change needed |
| `SMTP2GO_USER` | your SMTP2GO username | SMTP2GO dashboard → Settings → API Keys |
| `SMTP2GO_PASS` | your SMTP2GO password | SMTP2GO dashboard → same |
| `ADMIN_TOKEN` | (same as FLUX_ADMIN_TOKEN) | reuse value from above |
| `DOCS_URL` | `https://flux-universe.com/docs` | hardcoded — no change needed |
| `STRIPE_WEBHOOK_SECRET` | `whsec_...` | **leave blank for now** — fill in after Phase 6 |
| `PROVISIONER_DB` | `/home/etl/flux-provisioner/provisioner.db` | hardcoded — no change needed |

---

## Phase 5 — Install and start systemd service on .107

Run on **.107**:

```bash
sudo cp /home/etl/flux-provisioner/flux-provisioner.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable flux-provisioner
sudo systemctl start flux-provisioner
sudo systemctl status flux-provisioner
```

Smoke test — Flask is up if you get a 400 (invalid Stripe sig):

```bash
curl -s -w "\nHTTP %{http_code}\n" -X POST http://localhost:3002/webhook
# Expected: {"error":"invalid signature"}, HTTP 400
```

---

## Phase 6 — Add pay.flux-universe.com to Cloudflare tunnel on .107

Run on **.107**:

```bash
sudo nano /etc/cloudflared/config.yml
```

The file already has an entry for `api.flux-universe.com`. Add the new entry **before** the catch-all (`- service: http_status:404`):

```yaml
  - hostname: pay.flux-universe.com
    service: http://localhost:3002
```

The relevant section should look like:

```yaml
ingress:
  - hostname: api.flux-universe.com
    service: http://localhost:3000
  - hostname: pay.flux-universe.com
    service: http://localhost:3002
  - service: http_status:404
```

Then restart cloudflared:

```bash
sudo systemctl restart cloudflared
sudo systemctl status cloudflared
```

Verify tunnel works (expect 400 — same invalid sig response, now via public URL):

```bash
curl -s -w "\nHTTP %{http_code}\n" -X POST https://pay.flux-universe.com/webhook
# Expected: {"error":"invalid signature"}, HTTP 400
```

---

## Phase 7 — Configure Stripe webhook (manual dashboard step)

1. Go to **https://dashboard.stripe.com/webhooks** → **Add endpoint**
2. **Endpoint URL:** `https://pay.flux-universe.com/webhook`
3. **Events to send:** select `checkout.session.completed` only
4. Click **Add endpoint**, then reveal and copy the **Signing secret** (`whsec_...`)
5. On **.107**, add the secret to `.env`:
   ```bash
   nano /home/etl/flux-provisioner/.env
   # Set STRIPE_WEBHOOK_SECRET=whsec_...
   ```
6. Restart the service to pick up the new value:
   ```bash
   sudo systemctl restart flux-provisioner
   ```

---

## Phase 8 — End-to-end test with Stripe test mode

**Option A — Stripe CLI (simplest):**

```bash
stripe trigger checkout.session.completed \
  --override checkout_session:customer_email=test@example.com
```

**Option B — manual:** In the Stripe test dashboard, create a Payment Link or Checkout session. Complete it using test card `4242 4242 4242 4242`, any future expiry, any CVC.

After the test event fires:

```bash
# Check service logs
sudo journalctl -u flux-provisioner -n 50

# Check SQLite record
sqlite3 /home/etl/flux-provisioner/provisioner.db \
  "SELECT namespace_name, email, status FROM namespaces;"

# Check admin panel (replace YOUR_TOKEN with ADMIN_TOKEN value)
curl -s "http://192.168.50.107:3002/admin/api/namespaces?token=YOUR_TOKEN" | python3 -m json.tool
```

Success criteria:
- Logs show `Provisioned namespace=<name> for email=test@example.com`
- SQLite row exists with `status=active`
- Admin panel lists the namespace
- (Optional) test email received if SMTP2GO is configured

---

## Files Modified / Created

**On .107 (not in git):**
- `/home/etl/flux-provisioner/app.py` — provisioner Flask app
- `/home/etl/flux-provisioner/requirements.txt`
- `/home/etl/flux-provisioner/.env` — secrets (never commit)
- `/home/etl/flux-provisioner/templates/admin.html`
- `/etc/cloudflared/config.yml` — added pay.flux-universe.com ingress
- `/etc/systemd/system/flux-provisioner.service`

**On .107 Flux container (via git pull):**
- Flux binary rebuilt with DELETE namespace endpoint from Task 1
