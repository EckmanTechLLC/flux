# Session: ADR-009 Task 2 — Provisioner Core

**Date:** 2026-02-25
**Status:** Complete

---

## What Was Done

Created `/home/etl/flux-provisioner/` with all core provisioner files.

### Files Created

| File | Purpose |
|------|---------|
| `app.py` | Flask app — webhook handler, word-pair generator, SQLite, email |
| `requirements.txt` | flask, stripe, python-dotenv, requests |
| `.env.template` | Environment variable template (no real values) |
| `flux-provisioner.service` | systemd unit for gunicorn on port 3002 |

---

## Implementation Notes

**Word-pair generator:** 82 adjectives × 75 nouns (~6150 combinations). Avoids
weird or offensive words — nature/geography/quality theme.

**Collision handling:** Checks `GET /api/namespaces/{name}` (Bearer token auth),
retries up to 10 times. Raises `RuntimeError` if no unique name found.

**Idempotency:** Webhook checks SQLite for existing `stripe_session_id` before
provisioning. Stripe may retry; duplicate calls return 200 immediately.

**Email failure:** `send_email` logs but does not re-raise. Provisioning still
succeeds if email fails — namespace is already created and stored in SQLite.

**DB init:** `init_db()` called at module load (before first request). Safe to
call repeatedly — `CREATE TABLE IF NOT EXISTS`.

---

## Next Steps

### Before starting Task 3 (Admin Panel):
- Copy `.env.template` to `.env` and fill in real values on .107
- Install deps: `pip3 install -r requirements.txt --break-system-packages`
- Install gunicorn: `pip3 install gunicorn --break-system-packages`

### Task 3: Admin panel
- `GET /admin` — token-gated HTML dashboard
- `GET /admin/api/namespaces` — JSON list
- `POST /admin/api/namespaces` — manual provision
- `POST /admin/api/namespaces/:name/revoke` — call Flux DELETE + mark revoked
- `templates/admin.html` — simple HTML table

### Task 4: Cloudflare + Stripe wiring
- Add `pay.flux-universe.com` ingress to cloudflared config
- Create Stripe webhook, copy secret to `.env`
- End-to-end test with Stripe test mode

---

## Files Modified

None in Flux repo. All files at `/home/etl/flux-provisioner/` (private, no git).
