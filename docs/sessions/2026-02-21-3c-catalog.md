# Session: Phase 3C — Singer catalog fix

**Date:** 2026-02-21
**Status:** Complete

## Problem

Singer taps (including tap-github) require a `--catalog` argument that marks
streams as selected. Without it, the tap outputs only `STATE {}` and syncs
nothing. The previous `run_tap_once` called the tap without `--catalog`.

## Fix

`connector-manager/src/runners/named.rs` — refactored `run_tap_once`:

1. **Discover step** (new): before spawning the tap for sync, runs
   `tap --config {config_path} --discover` and captures its catalog JSON.
2. **Select all streams**: marks every stream as selected via `select_all_streams`
   (sets `selected: true` at the stream level for older taps, and in
   `metadata[breadcrumb=[]].metadata` for modern taps).
3. **Write catalog** to `/tmp/flux-tap-{id}-catalog.json`.
4. **Spawn with `--catalog`**: adds `--catalog {catalog_path}` to the sync command.
5. **Cleanup**: removes both config and catalog files after tap exits (state file kept).

Auto-install (pip) logic moved into `run_discover` — the tap is guaranteed
installed after a successful discover, so the main spawn no longer needs it.

## New helpers

- `run_discover(config, config_path) -> Result<String>` — runs `--discover`,
  pip-installs if missing, returns selected catalog JSON.
- `select_all_streams(catalog: &mut Value)` — mutates a Singer catalog to mark
  all streams selected (both conventions covered).

## Files Modified

- `connector-manager/src/runners/named.rs`

## Deploy

```
docker compose build --no-cache connector-manager && docker compose up -d connector-manager
```
